
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../chap05/">
      
      
        <link rel="next" href="../chap07/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.3">
    
    
      
        <title>6 从替换模型到环境模型 - Programming Languages: Application and Interpretation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.c4a75a56.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      
  


  
  


  <script id="__analytics">function __md_analytics(){function n(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],n("js",new Date),n("config","G-CRZZK8N4WE"),document.addEventListener("DOMContentLoaded",function(){document.forms.search&&document.forms.search.query.addEventListener("blur",function(){this.value&&n("event","search",{search_term:this.value})}),document$.subscribe(function(){var a=document.forms.feedback;if(void 0!==a)for(var e of a.querySelectorAll("[type=submit]"))e.addEventListener("click",function(e){e.preventDefault();var t=document.location.pathname,e=this.getAttribute("data-md-value");n("event","feedback",{page:t,data:e}),a.firstElementChild.disabled=!0;e=a.querySelector(".md-feedback__note [data-md-value='"+e+"']");e&&(e.hidden=!1)}),a.hidden=!1}),location$.subscribe(function(e){n("config","G-CRZZK8N4WE",{page_path:e.pathname})})});var e=document.createElement("script");e.async=!0,e.src="https://www.googletagmanager.com/gtag/js?id=G-CRZZK8N4WE",document.getElementById("__analytics").insertAdjacentElement("afterEnd",e)}</script>

  
    <script>"undefined"!=typeof __md_analytics&&__md_analytics()</script>
  

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="" data-md-color-accent="">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#6" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Programming Languages: Application and Interpretation" class="md-header__button md-logo" aria-label="Programming Languages: Application and Interpretation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Programming Languages: Application and Interpretation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              6 从替换模型到环境模型
            
          </span>
        </div>
      </div>
    </div>
    
    
    
    
      <div class="md-header__source">
        <a href="https://github.com/lotuc/PLAI-cn.git" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Programming Languages: Application and Interpretation" class="md-nav__button md-logo" aria-label="Programming Languages: Application and Interpretation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Programming Languages: Application and Interpretation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/lotuc/PLAI-cn.git" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        索引
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chap01/" class="md-nav__link">
        1 引言
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chap02/" class="md-nav__link">
        2 本书有关语法解析的一切
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chap03/" class="md-nav__link">
        3 解释器初窥
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chap04/" class="md-nav__link">
        4 初试去语法糖
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chap05/" class="md-nav__link">
        5 添加函数
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          6 从替换模型到环境模型
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        6 从替换模型到环境模型
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#61" class="md-nav__link">
    6.1 介绍环境模型
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#62" class="md-nav__link">
    6.2 环境模型解释器
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#63" class="md-nav__link">
    6.3 正确的进行延迟求值
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#64" class="md-nav__link">
    6.4 作用域
  </a>
  
    <nav class="md-nav" aria-label="6.4 作用域">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#641" class="md-nav__link">
    6.4.1 动态作用域到底有多糟糕
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#642" class="md-nav__link">
    6.4.2 全局作用域
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#65" class="md-nav__link">
    6.5 暴露环境
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chap07/" class="md-nav__link">
        7 任意位置的函数
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chap08/" class="md-nav__link">
        8 可变结构体和变量
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chap09/" class="md-nav__link">
        9 递归和循环：子程序与数据
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chap10/" class="md-nav__link">
        10 对象
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chap11/" class="md-nav__link">
        11 内存管理
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chap12/" class="md-nav__link">
        12 表示层抉择
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chap13/" class="md-nav__link">
        13 语言中支持去语法糖
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chap14/" class="md-nav__link">
        14 控制指令
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chap15/" class="md-nav__link">
        15 静态地检查程序中的不变量：类型
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chap16/" class="md-nav__link">
        16 动态地检查程序中的不变量：契约
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chap17/" class="md-nav__link">
        17 其他调用语义
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#61" class="md-nav__link">
    6.1 介绍环境模型
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#62" class="md-nav__link">
    6.2 环境模型解释器
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#63" class="md-nav__link">
    6.3 正确的进行延迟求值
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#64" class="md-nav__link">
    6.4 作用域
  </a>
  
    <nav class="md-nav" aria-label="6.4 作用域">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#641" class="md-nav__link">
    6.4.1 动态作用域到底有多糟糕
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#642" class="md-nav__link">
    6.4.2 全局作用域
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#65" class="md-nav__link">
    6.5 暴露环境
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="6">6 从替换模型到环境模型</h1>
<p>尽管我们已经实现了函数，你可能对其不太满意。处理标识符时，直观上应该是“找到它绑
定的值”。但是我们不仅没这样做，还在遇到标识符时直接抛出错误！这么做也没错，但感
觉怪怪的。更重要的是，编写解释器是为了让其<strong>理解并解释</strong>我们的语言，而该解释器现
在看来并没有达成我们的意愿。</p>
<p>使用替换模型的另一个问题是，它需要遍历源程序的次数。理想的做法是，只访问程序中被
实际求值的部分，并且，仅当必要时才这么做。替换模型必须遍历程序的所有部分——比如说
，条件分支中不执行的分支——而且还需要遍历程序两遍，一遍替换，一遍解释。</p>
<p><strong>练习</strong></p>
<blockquote>
<p>替换模型会影响程序运行的时间复杂性吗？</p>
</blockquote>
<p>替换模型还有个问题，它的结构受限于源代码的存储。当然，我们的解释器需要源代码，对
其解释。但是其他实现方式——比如说编译器—— 并不需要存贮源代码。【注释】采取更一般
的策略，不依赖于具体实现方式显然更为合理。</p>
<blockquote>
<p>编译器可能也需要存储某些源代码信息，以实现其他功能。比如说，报告运行时错误时，
或者进行即时编译（JIT）。</p>
</blockquote>
<h2 id="61">6.1 介绍环境模型</h2>
<p>直觉告诉我们，解决第一个问题的方法是，解释器可以在某种形式的字典里面“寻找”标识符
；解决第二个问题的方法是，<strong>延迟</strong>替换。幸运的是，这两点结合起来还能解决第三个问
题。字典里面记录的是<strong>将要进行的替换</strong>，而并不对原始程序进行修改。因为记录下了将
要进行的替换，而并非直接替换，我们可以延迟进行替换步骤。记录替换内容的数据结构被
称为<strong>环境</strong>（environment）。使用环境模型避免了源代码级别的重写，并且和底层的计
算机表示法很好地对应。环境中的结合关系被称为<strong>绑定</strong>（binding）。</p>
<p>注意，这里我们要修改的是编程语言的<strong>实现策略</strong>，而不是<strong>修改语言本身</strong>。因此用于
表示程序的数据结构，还有解释器执行的结果都不应发生改变。所以，我们可以将之前那个
解释器当作我们这次要写的解释器的“参考实现”，两者的结果应该一致。实际上，我们应该
创建一个测试生成器，让它生成很多测给两个解释器来执行，并确保它们返回的结果都相同
。理想情况下，我们应该<strong>证明</strong>两个解释器行为一致，事实上它是很好的高阶课题。</p>
<blockquote>
<p>这里的“一致”到底是什么意思呢？特别地，当程序运行报错时呢？</p>
</blockquote>
<p>首先，我们来定义环境的数据结构。环境是将名字与什么的绑定的表？</p>
<p><strong>思考题</strong></p>
<blockquote>
<p>这里定义数据结构时，很自然的问题就是，环境中将名字映射成了什么东西。但是我们可
以问更好更基本的问题，我们如何得出这个很自然问题的答案？</p>
</blockquote>
<p>记住我们这里引入环境是为了推迟替换过程。因此，答案在替换中。我们
在<a href="./chap5.md#55-等等还没完呢">上一章最后一节</a>中讨论过，我们希望直接将名字替换为
计算结果，即对应于函数的及早求值策略。因此同样的，环境中应该将名字映射为求值结果
。</p>
<pre><code class="language-racket">(define-type Binding
  [bind (name : symbol) (val : number)])

(define-type-alias Env (listof Binding))
(define mt-env empty)
(define extend-env cons)
</code></pre>
<h2 id="62">6.2 环境模型解释器</h2>
<p>现在可以实现解释器了。除最简单的分支情况外，其它代码均需要重新考虑：</p>
<pre><code class="language-racket">&lt;*&gt; ::=

    (define (interp [expr : ExprC] [env : Env] [fds : (listof FunDefC)]) : number
      (type-case ExprC expr
        [numC (n) n]
        &lt;idC-case&gt;  ;标识符子句
        &lt;appC-case&gt;  ;调用子句
        &lt;plusC/multC-case&gt;))  ;加法乘法子句
</code></pre>
<p>算术操作是最好写的。回忆一下，递归中未涉及到新的替换，因此无需特别处理，环境不会
发生改变：</p>
<pre><code class="language-racket">&lt;plusC/multC-case&gt; ::=  ;加法乘法子句

    [plusC (l r) (+ (interp l env fds) (interp r env fds))]
    [multC (l r) (* (interp l env fds) (interp r env fds))]
</code></pre>
<p>接下来我们处理标识符。显然，现在遇到标识符不应该直接报错了。我们应该在当前环境中
查找对应的值：</p>
<pre><code class="language-racket">&lt;idC-case&gt; ::=  ;标识符子句

    [idC (n) (lookup n env)]
</code></pre>
<p><strong>思考题</strong></p>
<blockquote>
<p>实现 lookup 函数。</p>
</blockquote>
<p>最后，处理函数调用。注意到在替换模型的解释器中，唯一创建新替换的部分就是函数调用
。因此这个地方会是需要创建绑定的地方。第一步，跟之前一样，提取函数定义：</p>
<pre><code class="language-racket">&lt;appC-case&gt; ::=  ;调用子句

    [appC (f a) (let ([fd (get-fundef f fds)])
                  &lt;appC-interp&gt;)]  ;调用的解释
</code></pre>
<p>之前，我们是先进行替换，然后解释。现在剔除掉替换这个步骤，我们首先记录下要替换的
东西，然后直接进入解释步骤：</p>
<pre><code class="language-racket">&lt;appC-interp&gt; ::=  ;调用的解释

    (interp (fdC-body fd)
            &lt;appC-interp-bind-in-env&gt;  ;调用的解释，环境绑定
            fds)
</code></pre>
<p>也就是说，函数定义部分保持不变；我们照旧解释函数的主体部分；不过解释过程要被放在
新的环境中，该环境包含了函数形式参数的绑定。接下来定义绑定过程：</p>
<pre><code class="language-racket">&lt;appC-interp-bind-in-env-take-1&gt; ::=  ;调用的解释，环境绑定，第一次尝试

    (extend-env (bind (fdC-arg fd)
                      (interp a env fds))
                env)
</code></pre>
<p>要绑定的是形参（之前被替换的也是形参）。绑定的值是函数参数解释求值的结果（因为我
们采取及早求值语义）。这就需要扩充我们的环境。类型检查确保我们得到的代码是正确的
。</p>
<p>最后加上 lookup 函数的实现，一切就都完成了：</p>
<pre><code class="language-racket">(define (lookup [for : symbol] [env : Env]) : number
  (cond
    [(empty? env) (error 'lookup &quot;name not found&quot;)]  ;找不到名称
    [else (cond
            [(symbol=? for (bind-name (first env)))
             (bind-val (first env))]
            [else (lookup for (rest env))])]))
</code></pre>
<p>请注意，查找自由标识符时依旧会报错，但是这一步从解释器中被剥离出来——解释器并无法
判断某个标识符是否被绑定——由 lookup 函数根据当前环境来决定。</p>
<p>完成解释器后，当然需要测试以确保其正确性。下面这几个测试都通过了：</p>
<pre><code class="language-racket">(test (interp (plusC (numC 10) (appC 'const5 (numC 10)))
              mt-env
              (list (fdC 'const5 '_ (numC 5))))
      15)

(test (interp (plusC (numC 10) (appC 'double (plusC (numC 1) (numC 2))))
              mt-env
              (list (fdC 'double 'x (plusC (idC 'x) (idC 'x)))))
      16)

(test (interp (plusC (numC 10) (appC 'quadruple (plusC (numC 1) (numC 2))))
              mt-env
              (list (fdC 'quadruple 'x (appC 'double (appC 'double (idC 'x))))
                    (fdC 'double 'x (plusC (idC 'x) (idC 'x)))))
      22)
</code></pre>
<p>所以，我们是已经完成任务了，对吧？</p>
<p><strong>思考题</strong></p>
<blockquote>
<p>找找看 bug 在哪。</p>
</blockquote>
<h2 id="63">6.3 正确的进行延迟求值</h2>
<p>考虑下面这个测试：</p>
<pre><code class="language-racket">(interp (appC 'f1 (numC 3))
                  mt-env
                  (list (fdC 'f1 'x (appC 'f2 (numC 4)))
                        (fdC 'f2 'y (plusC (idC 'x) (idC 'y)))))
</code></pre>
<p>在我们的解释器中，它的结果为 7。这正确吗？</p>
<p>将这个测试转换成 Racket 代码，两个定义加一个表达式：</p>
<pre><code class="language-racket">(define (f1 x) (f2 4))
(define (f2 y) (+ x y))

(f1 3)
</code></pre>
<p>考虑其求值过程。<code>(f1 3)</code>将函数<code>f1</code>的函数体中<code>x</code>替换为 3，于是下一步处
理<code>(f2 4)</code>。但是注意到在函数<code>f2</code>中， 标识符<code>x</code><strong>未绑定</strong>！当然 Racket 报错了。</p>
<p>事实上，我们的替换模型解释器也会报错！</p>
<p>为什么我们的替换模型会报错呢？这是因为，我们<strong>仅</strong>会在<code>f1</code>的函数体内将标识
符<code>x</code>替换为数 3 的表示。【注释】（这是显而易见的事：<code>x</code>是<code>f1</code>的参数；如果其它函
数的参数名碰巧也叫<code>x</code>，那也是个<strong>不同的</strong><code>x</code>）。当我们计算<code>f2</code>时，其中<code>x</code>没有被
替换过，因此报错了。</p>
<blockquote>
<p>“数 3 的表示”听上去是不是很罗嗦？以后这类情况我就直接说“3”了，不过请你理解这其
中的区别。</p>
</blockquote>
<p>那么我们环境模型的问题到底出在哪呢？请仔细观察，这一点很微妙。只有函数调用过程会
改变环境，我们重点观察这一步。将形参替换成实参是通过<strong>扩展当前环境</strong>实现的。在我
们的例子中，在处理<code>f2</code>函数体时，我们不仅要求它对<code>f2</code>的参数进行替换，还要它对当前
所有环境中的参数（也就是调用<code>f2</code>的<code>f1</code>的参数）都进行替换。如果还有上一层，它的参
数也会被替换。换一种说法，添加到环境中的绑定只增不减。</p>
<p>由于前面说过，环境模型是替换模型的替代实现策略——我们的语言意义不应该发生改变——唯
一合理的做法是修改解释器。具体来说，我们不应该让解释过程携带所有历史绑定，而应为
每个函数创建干净的环境，类似替换模型的做法。很容易实现：</p>
<pre><code class="language-racket">&lt;appC-interp-bind-in-env&gt; ::=  ;调用的解释，环境绑定

    (extend-env (bind (fdC-arg fd)
                      (interp a env fds))
                mt-env)
</code></pre>
<p>到此，我们重现了替换模型解释器的行为。</p>
<blockquote>
<p>对于需要报错的情况，测试该怎么写呢？请查阅 test/exn 的文档。</p>
</blockquote>
<h2 id="64">6.4 作用域</h2>
<p>上面那个错误的环境模型解释器，所实现的语义被称为<strong>动态作用域（dynamic
scope）</strong>。它意味着随着程序的执行，环境中的绑定不断增加。于是，某个标识符是否被
绑定取决于程序的执行历史。这应该被视作程序语言设计的缺陷。它增加了所有相关工具的
复杂度，如编译器、IDE，也使得其代码难于阅读维护。</p>
<p>与之对应的，替换模型，以及上面正确实现的环境模型，给我们带来的是<strong>词法作用域
（lexical scope）</strong> 或称<strong>静态作用域（static scope）</strong>。这里“词法（lexical）”指
的是 “通过源码即可确定”；“静态（static）”指的是“不需运行程序即可确定”，在这里，
这两者指代的意义相同。当遇到标识符时，我们希望知道两件事：</p>
<ol>
<li>它是否被绑定了？</li>
<li>如果被绑定，在何处被绑定的？</li>
</ol>
<p>这里“何处被绑定”指的是当程序中某个名字在多处被绑定，当前这个名字对应于哪个绑定。
换一种说法，那个绑定负责当前标识符的绑定？一般来说，在动态作用域的语言中，这种问
题没有静态的答案；于是你的 IDE 没法提示你某个变量是在哪个地方被定义的（DrRacket
可以通过画箭头的方式提示此类信息）。【注释】因此，随着命名空间变得更为复杂（比如
引入对象、线程等概念），我们仍需努力维护静态作用域原则。</p>
<blockquote>
<p>思考这个问题的另一种方法是，在动态作用域的语言中，<strong>所有</strong>变量的绑定位置都没法
静态确定，它总是取决于动态的环境。换一种说法，这种信息毫无价值。</p>
</blockquote>
<h3 id="641">6.4.1 动态作用域到底有多糟糕</h3>
<p>可能看到上述的例子，你会觉得这是小题大作。但是，请考虑这两件事：</p>
<ol>
<li>要真正理解动态作用域的程序，你<strong>必需阅读整个程序</strong>。不管你怎么将程序进行解耦
   成易于理解的小的部分，如果程序中有个自由变量呢。</li>
<li>要理解绑定关系，其复杂度不仅涉及到程序的<strong>体积</strong>，还牵扯到控制流的复杂度。考
   虑使用了很多回调的交互式程序，你需要追踪整个调用过程来确定某个标识符的值的来
   源。</li>
</ol>
<p>还不够有说服力？让我们把示例程序中的表达式替换为：</p>
<pre><code class="language-racket">(if (moon-visible?)
    (f1 10)
    (f2 10))
</code></pre>
<p>假设<code>moon-visible?</code>函数在新月的夜晚其值为假，其他情况下为真。于是我们的程序应当
在新月夜晚报错，未绑定变量，而在其他情况下返回某个值。</p>
<p><strong>练习</strong></p>
<blockquote>
<p>在多云的夜晚呢？</p>
</blockquote>
<h3 id="642">6.4.2 全局作用域</h3>
<p>当我们深入思考很多语言中全局的定义时，事情会变得更加复杂。例如，一些版本的
Scheme（典型的词法作用域语言）允许你写出这样的程序：</p>
<pre><code class="language-scheme">(define y 1)
(define (f x) (+ x y))
</code></pre>
<p>看上去好像函数<code>f</code>中的<code>y</code>来源很清晰，不过：</p>
<pre><code class="language-scheme">(define y 1)
(define (f x) (+ x y))
(define y 2)
</code></pre>
<p>这是合法的，且计算<code>(f 10)</code>时它返回 12。你可能会想，那么取最后一个定义就对了！。
但是：</p>
<pre><code class="language-scheme">(define y 1)
(define f (let ((z y)) (lambda (x) (+ x y z))))
(define y 2)
</code></pre>
<p>这时候，<code>z</code>绑定的是第一个<code>y</code>的值，lambda 函数内部的<code>y</code>被绑定为第二个<code>y</code>的值。【
注释】事实上可以通过词法作用域解释这种行为，但是它让情况变得异常复杂，可能避免这
样的重定义是一种比较好的选择。Racket 正是这样做的（在 Racket 中这么操作会导致报
错），它能提供用户全局定义，同时又避免这类麻烦事。</p>
<blockquote>
<p>很多“脚本”语言都有类似的问题。所以网上你会看到很多人搞不清楚某种语言到底是静态
还是动态作用域的。其实很多情况下人们只是在比较函数内的行为（通常是静态作用域）
还是全局的行为（通常是动态作用域）。请注意这一点。</p>
</blockquote>
<h2 id="65">6.5 暴露环境</h2>
<p>如果是实现供别人使用的解释器，明智的选择是将环境隐藏起来，给用户提供的接口只接收
一个表达式，外加一系列函数定义，然后我们在程序内部从空白的环境开始调用 interp。
这样即不用将实现细节暴露给用户，也不会由于用户提供错误的环境导致问题。然而，有些
情况下，暴露环境参数也是有用的。比如如果语言希望默认绑定一系列值:比如说，
将<code>pi</code>绑定到 3.2（<a href="https://en.wikipedia.org/wiki/Indiana_Pi_Bill">Indiana</a>）。</p>


  




<h2 id="__comments">Comments</h2>
<script src="https://giscus.app/client.js"
        data-repo="lotuc/giscus"
        data-repo-id="R_kgDOJRx9Aw"
        data-category="General"
        data-category-id="DIC_kwDOJRx9A84CVe05"
        data-mapping="title"
        data-strict="0"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-input-position="bottom"
        data-theme="light"
        data-lang="en"
        crossorigin="anonymous"
        async>
</script>

<!-- Synchronize Giscus theme with palette -->
<script>
 var giscus = document.querySelector("script[src*=giscus]")

 /* Set palette on initial load */
 var palette = __md_get("__palette")
 if (palette && typeof palette.color === "object") {
   var theme = palette.color.scheme === "slate" ? "dark" : "light"
   giscus.setAttribute("data-theme", theme)
 }

 /* Register event handlers after documented loaded */
 document.addEventListener("DOMContentLoaded", function() {
   var ref = document.querySelector("[data-md-component=palette]")
   ref.addEventListener("change", function() {
     var palette = __md_get("__palette")
     if (palette && typeof palette.color === "object") {
       var theme = palette.color.scheme === "slate" ? "dark" : "light"

       /* Instruct Giscus to change theme */
       var frame = document.querySelector(".giscus-frame")
       frame.contentWindow.postMessage(
         { giscus: { setConfig: { theme } } },
         "https://giscus.app"
       )
     }
   })
 })
</script>

                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.efa0ade1.min.js"></script>
      
        <script src="../js/mathjax.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
    
  </body>
</html>